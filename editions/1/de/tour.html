<title>Der Anfang</title>

<meta charset="utf-8">

<link rel="stylesheet" href="../../../style.css">

<link rel="prev" href="consistency.html">

<link rel="next" href="api.html">

<script src="../../../script.js"></script>

<h2 id="tour">Der Anfang</h2>

<p>In diesem Kapitel werden wir die einzelnen Funktionen von CouchDB kurz vorstellen. Dazu gehört auch <em>Futon</em>, die integrierte Administrationsanwendung. Wir werden ein erstes Dokument anlegen und die Views von CouchDB genauer untersuchen. Zunächst jedoch muß CouchDB installiert und konfiguriert werden. Die passende Anleitung für das jeweilige Betriebssystem sind in <a href="source.html">Anhang D - Installation von den Sourcen</a>.

<h3 id="go">Alles auf Grün</h3>

<p>Anfangen wollen wir mit dem kompakten CouchDB <em>API (Application Programming Interface)</em>, welches mit dem Kommandozeilentool <code>curl</code> bedient werden kann. Das ist nur ein möglicher Weg, um mit CouchDB zu arbeiten. Es gibt noch viele andere Wege, die wir im Laufe des Buchs noch vorstellen werden. Das Interessante an <code>curl</code> ist, dass es volle Kontrolle über die reinen HTTP Requests erlaubt, denn man sieht genau was „unter der Haube“ passiert. 

<p>Zunächst stellen wir sicher, dass CouchDB noch läuft. Danach führen wir folgendes Kommando aus:

<pre>
curl http://127.0.0.1:5984/
</pre>

<p>Das sendet einen <code>GET</code> Request zu CouchDB.

<p>Die Antwort sollte ungefähr so aussehen:

<pre>
{"couchdb":"Welcome","version":"0.10.1"}
</pre>

<p>Nicht besonders aufregend. CouchDB sagt „Hallo“ und teilt uns seine Versionsnummer mit. 

<p>Anschließend holen wir die Liste der verfügbaren Datenbanken:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>Dazu mussten wir lediglich <code>_all_dbs</code> an den vorherigen Request anhängen.

<p>Die Antwort sollte ungefähr so aussehen:

<pre>
[]
</pre>

<p>Hmm, vielleicht sollten wir zuerst eine Datenbank anlegen. Was wir zurückbekommen haben ist eine leere Liste.

<div class="aside note">

<p><code>curl</code> sendet standardmäßig <code>GET</code> Requests. Um <code>POST</code> Requests zu verschicken, muss man <code>curl -X POST</code> verwenden. Um die Terminal History verwenden zu können, nutzen wir in der Regel die <code>-X</code> Option auch bei <code>GET</code> Requests. Beim nächsten <code>POST</code> Request müssen wir dann nur die Methode ändern.

<p>Unter der Haube ist der HTTP Request etwas komplexer als er hier dargstellt wird. Um alle Details von Request und Response zu sehen, verwendet man die <code>-v</code> Option (z.B. <code>curl -vX GET</code>). Damit werden der Host, mit dem sich <code>curl</code> verbindet sowie sämtliche Header angezeigt. Ideal zum Debuggen!

</div>

<p>Legen wir eine Datenbank an:

<pre>
curl -X PUT http://127.0.0.1:5984/baseball
</pre>

<p>CouchDB antwortet mit:

<pre>
{"ok":true}
</pre>

<p>Diesmal ist die Liste der verfügbaren Datenbanken etwas umfangreicher:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>CouchDB antwortet mit:

<pre>
["baseball"]
</pre>

<div class="aside note">

<p>Das ist eine gute Gelegenheit die <em>JavaScript Object Notation (JSON)</em> zu erwähnen — die Sprache für Daten in CouchDB. JSON ist ein schlankes Format zum Austausch von Daten auf Basis der JavaScript Syntax. Da JSON direkt von JavaScript verstanden wird, ist der Web Browser ein idealier Client für CouchDB.

<p>Eckige Klammern (<code>[]</code>) sind sortierte Listen und geschweifte Klammern (<code>{}</code>) sind Key/Value Hashmaps. Die Schlüssel müssen Strings mit doppelten Anführungszeichen (<code>"</code>) sein. Die Werte können Strings, Zahlen, Bool'sche Werte, Listen oder andere Key/Value Hashmaps sein. Eine ausführlichere Beschreibugn von JSON ist im <a href="json.html">Anhang E — JSON Einführung</a>.

</div>

<p>Legen wir noch eine Datenbank an:

<pre>
curl -X PUT http://127.0.0.1:5984/baseball
</pre>

<p>CouchDB antwortet mit:

<pre>
{"error":"file_exists","reason":"The database could not be created, the file already exists."}
</pre>

<p>Da es schon eine Datenbank mit diesem Namen gibt, antwortet CouchDB mit einer Fehlermeldung. Versuchen wir es mit einen anderen Namen:

<pre>
curl -X PUT http://127.0.0.1:5984/plankton
</pre>

<p>CouchDB antwortet mit:

<pre>
{"ok":true}
</pre>

<p>Die Liste der verfügbaren Datenbanken sollte nun beide Datenbanken anzeigen:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>CouchDB antwortet mit:

<pre>
["baseball", "plankton"]
</pre>

<p>Zum Abschluß entfernen wir die zweite Datenbank:

<pre>
curl -X DELETE http://127.0.0.1:5984/plankton
</pre>

<p>CouchDB antwortet mit:

<pre>
{"ok":true}
</pre>

<p>Die Liste der Datenbanken ist nun wieder so wie vorher:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>CouchDB antwortet mit:

<pre>
["baseball"]
</pre>

<p>Um die Sache abzukürzen, überspringen wir das Arbeiten mit Dokumenten, da der nächste Abschnitte einen anderen und wahrscheinlich einfacheren Weg zeigt, um mit CouchDB Dokumente zu verwalten. Während wir durch die Beispiele gehen, sollten wir im Hinterkopf behalten, dass die Anwendung „unter der Haube“ genauso arbeitet, wie wir in den vorherigen Beispielen. Alle Aktionen werden über eine URI und <code>GET</code>, <code>PUT</code>, <code>POST</code> und <code>DELETE</code> durchgeführt.

<h3 id="welcome">Willkommen zu Futon</h3>

<p>Nachdem wir die nackte HTTP Schnittstelle von CouchDB gesehen haben, gehen wir einen Schritt weiter zu Futon, der integrierten Administrationsanwendung. Futon bietet vollen Zugang zu sämtlichen Funktionen von CouchDB und macht es einfach mit den komplexeren Features von CouchDB zu experementieren. Mit Futon kann man Datenbanken anlegen und löschen, Dokumente anzeigen und bearbeiten, MapReduce Views erzeugen und ausführen als auch die Replikation zwischen Datenbanken anstoßen.

<p>Um Futon zu laden müssen wir folgende URL öffnen:

<pre>
http://127.0.0.1:5984/_utils/
</pre>

<p>Ab Version 0.9 oder später sollte die Oberfläche ungefähr wie in <a href="#figure/1">Abbildung 1 „Der Futon Home Screen”</a> aussehen. In späteren Kapiteln gehen wir dann mehr darauf ein, CouchDB mit Server Sprachen wir Ruby und Python zu nutzen. Deshalb ist das jetzt eine gute Gelegenheit zu zeigen, wie man eine dynamische Webanwendung ausschließlich mit CouchDB und seinem integrierten Webserver ausliefert. Das ist vielleicht auch etwas für ihre Anwendungen.

<p>Das erste, was man mit einer neuen CouchDB Installation machen sollte, ist die Test Suite auszuführen, um sicherzustellen, dass alles korrekt funktioniert. Liefern die Tests keine Fehler kann ausgeschlossen werden, dass spätere Probleme an einem fehlerhaften Setup liegen. Zugleich ist ein Fehler in der Test Suite ein Warnzeichen, die Installation noch einmal genau zu überprüfen bevor man einen eventuell defekten Datenbankserver produktiv einsetzt. Damit sparen wir uns viele Kopfschmerzen, wenn die Dinge nicht so laufen, wie sie sollten.

<div class="figure" id="figure/1">

<img src="tour/01.png">

<p class="caption">Abbildung 1: Der Futon Home Screen

</div>

<div class="aside warning">

<p>Bei einigen Netzwerkkonfigurationen schlagen die Tests für die Replikation fehl, wenn auf den CouchDB Server über <code>localhost</code> zugegriffen wird. Das kann man umgehen, indem man stattdessen direkt über die IP Adresse mit <code>http://127.0.0.1:5984/_utils/</code> zugreift.

</div>

<p>Um die Test Suite auszuführen, klickt man rechts in der Futon Seitenleiste auf „Test Suite“ und anschließend oben auf „Run all“ um die Tests zu starten. <a href="#figure/2">Abbildung 2 Futon Test Suite in Aktion</a> zeigt die Futon Test Suite während die Tests ausgeführt werden

<div class="figure" id="figure/2">

<img src="tour/02.png">

<p class="caption">Abbildung 2: Futon Test Suite in Aktion

</div>

<p>Da die Test Suite vom Browser aus gestartet wird, testet sie nicht nur die Funktion von CouchDB, sondern auch das die Kommunikation zwischen Browser und CouchDB korrekt funktioniert. Das kann sehr hilfreich sein, schlecht konfigurierte Proxies oder andere HTTP Middleware zu erkennen.

<div class="aside warning">

<p>Falls die Test Suite eine ungewöhnlich hohe Anzahl von Fehlern produziert, sollten sie den Abschnitt Troubleshooting in <a href="source.html">Anhang D Installation von Source</a> durchlesen, um die Installation zu reparieren.

</div>

<p>Nachdem die Test Suite erfolgreich durchlaufen wurde, wissen sie, dass ihre CouchDB Installation korrekt arbeitet und es kann weiter gehen mit den anderen Funktionen, die Futon zu bieten hat.

<h3 id="first">Your First Database and Document</h3>

<p>Creating a database in Futon is simple. From the overview page, click “Create Database.” When asked for a name, enter <code>hello-world</code> and click the Create button.

<p>After your database has been created, Futon will display a list of all its documents. This list will start out empty (<a href="#figure/3">Figure 3, “An empty database in Futon”</a>), so let’s create our first document. Click the “Create Document” link and then the Create button in the pop up. Make sure to leave the document ID blank, and CouchDB will generate a UUID for you.

<div class="aside warning">

<p>For demoing purposes, having CouchDB assign a UUID is fine. When you write your first programs, we recommend assigning your own UUIDs. If your rely on the server to generate the UUID and you end up making two POST requests because the first POST request bombed out, you might generate two docs and never find out about the first one because only the second one will be reported back. Generating your own UUIDs makes sure that you’ll never end up with duplicate documents.

</div>

<p>Futon will display the newly created document, with its <code>_id</code> and <code>_rev</code> as the only fields. To create a new field, click the “Add Field” button. We’ll call the new field <code>hello</code>. Click the green check icon (or hit the Enter key) to finalize creating the <code>hello</code> field. Double-click the <code>hello</code> field’s value (default <code>null</code>) to edit it.

<p>If you try to enter <code>world</code> as the new value, you’ll get an error when you click the value’s green check icon. CouchDB values must be entered as valid JSON. Instead, enter <code>"world"</code> (with quotes) because this is a valid JSON string. You should have no problems saving it. You can experiment with other JSON values; e.g., <code>[1, 2, "c"]</code> or <code>{"foo":"bar"}</code>. Once you’ve entered your values into the document, make a note of its <code>_rev</code> attribute and click “Save Document.” The result should look like <a href="#figure/4">Figure 4, “A “hello world” document in Futon”</a>.

<div class="figure" id="figure/3">

<img src="tour/03.png">

<p class="caption">Figure 3. An empty database in Futon

</div>

<div class="figure" id="figure/4">

<img src="tour/04.png">

<p class="caption">Figure 4. A “hello world” document in Futon

</div>

<p>You’ll notice that the document’s <code>_rev</code> has changed. We’ll go into more detail about this in later chapters, but for now, the important thing to note is that <code>_rev</code> acts like a safety feature when saving a document. As long as you and CouchDB agree on the most recent <code>_rev</code> of a document, you can successfully save your changes.

<p>Futon also provides a way to display the underlying JSON data, which can be more compact and easier to read, depending on what sort of data you are dealing with. To see the JSON version of our “hello world” document, click the Source tab. The result should look like <a href="#figure/5">Figure 5, “The JSON source of a “hello world” document in Futon”</a>.

<div class="figure" id="figure/5">

<img src="tour/05.png">

<p class="caption">Figure 5. The JSON source of a “hello world” document in Futon

</div>

<h3 id="mapreduce">Running a Query Using MapReduce</h3>

<p>Traditional relational databases allow you to run any queries you like as long as your data is structured correctly. In contrast, CouchDB uses predefined <em>map</em> and <em>reduce</em> functions in a style known as MapReduce. These functions provide great flexibility because they can adapt to variations in document structure, and indexes for each document can be computed independently and in parallel. The combination of a map and a reduce function is called a <em>view</em> in CouchDB terminology.

<div class="aside note">

<p>For experienced relational database programmers, MapReduce can take some getting used to. Rather than declaring which rows from which tables to include in a result set and depending on the database to determine the most efficient way to run the query, reduce queries are based on simple range requests against the indexes generated by your map functions.

</div>

<p>Map functions are called once with each document as the argument. The function can choose to skip the document altogether or <em>emit</em> one or more view rows as key/value pairs. Map functions may not depend on any information outside of the document. This independence is what allows CouchDB views to be generated incrementally and in parallel.

<p>CouchDB views are stored as rows that are kept sorted by key. This makes retrieving data from a range of keys efficient even when there are thousands or millions of rows. When writing CouchDB map functions, your primary goal is to build an index that stores related data under nearby keys.

<p>Before we can run an example MapReduce view, we’ll need some data to run it on. We’ll create documents carrying the price of various supermarket items as found at different stores. Let’s create documents for apples, oranges, and bananas. (Allow CouchDB to generate the <code>_id</code> and <code>_rev</code> fields.) Use Futon to create documents that have a final JSON structure that looks like this:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "apple",
    "prices" : {
        "Fresh Mart" : 1.59,
        "Price Max" : 5.99,
        "Apples Express" : 0.79
    }
}
</pre>

<p>This document should look like <a href="#figure/6">Figure 6, “An example document with apple prices in Futon”</a> when entered into Futon.

<div class="figure" id="figure/6">

<img src="tour/06.png">

<p class="caption">Figure 6. An example document with apple prices in Futon

</div>

<p>OK, now that that’s done, let’s create the document for oranges:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "orange",
    "prices" : {
        "Fresh Mart" : 1.99,
        "Price Max" : 3.19,
        "Citrus Circus" : 1.09
    }
}
</pre>

<p>And finally, the document for bananas:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "banana",
    "prices" : {
        "Fresh Mart" : 1.99,
        "Price Max" : 0.79,
        "Banana Montana" : 4.22
    }
}
</pre>

<p>Imagine we’re catering a big luncheon, but the client is very price-sensitive. To find the lowest prices, we’re going to create our first view, which shows each fruit sorted by price. Click “hello-world” to return to the hello-world overview, and then from the “select view” menu choose “Temporary view…” to create a new view. The result should look something like <a href="#figure/7">Figure 7, “A temporary view in Futon”</a>.

<div class="figure" id="figure/7">

<img src="tour/07.png">

<p class="caption">Figure 7. A temporary view in Futon

</div>

<p>Edit the map function, on the left, so that it looks like the following:

<pre>
function(doc) {
    var store, price, value;
    if (doc.item &amp;&amp; doc.prices) {
        for (store in doc.prices) {
            price = doc.prices[store];
            value = [doc.item, store];
            emit(price, value);
        }
    }
}
</pre>

<p>This is a <em>JavaScript</em> function that CouchDB runs for each of our documents as it computes the view. We’ll leave the reduce function blank for the time being.

<p>Click “Run” and you should see result rows like in <a href="#figure/8">Figure 8, “The results of running a view in Futon”</a>, with the various items sorted by price. This map function could be even more useful if it grouped the items by type so that all the prices for bananas were next to each other in the result set. CouchDB’s key sorting system allows any valid JSON object as a key. In this case, we’ll emit an array of <code>[item, price]</code> so that CouchDB groups by item type and price.

<div class="figure" id="figure/8">

<img src="tour/08.png">

<p class="caption">Figure 8. The results of running a view in Futon

</div>

<p>Let’s modify the view function so that it looks like this:

<pre>
function(doc) {
    var store, price, key;
    if (doc.item &amp;&amp; doc.prices) {
        for (store in doc.prices) {
            price = doc.prices[store];
            key = [doc.item, price];
            emit(key, store);
        }
    }
}
</pre>

<p>Here, we first check that the document has the fields we want to use. CouchDB recovers gracefully from a few isolated map function failures, but when a map function fails regularly (due to a missing required field or other JavaScript exception), CouchDB shuts off its indexing to prevent any further resource usage. For this reason, it’s important to check for the existence of any fields before you use them. In this case, our map function will skip the first “hello world” document we created without emitting any rows or encountering any errors. The result of this query should look like <a href="#figure/9">Figure 9, “The results of running a view after grouping by item type and price”</a>.

<div class="figure" id="figure/9">

<img src="tour/09.png">

<p class="caption">Figure 9. The results of running a view after grouping by item type and price

</div>

<p>Once we know we’ve got a document with an item type and some prices, we iterate over the item’s prices and emit key/values pairs. The key is an array of the item and the price, and forms the basis for CouchDB’s sorted index. In this case, the value is the name of the store where the item can be found for the listed price.

<p>View rows are sorted by their keys—in this example, first by item, then by price. This method of complex sorting is at the heart of creating useful indexes with CouchDB.

<div class="aside note">

<p>MapReduce can be challenging, especially if you’ve spent years working with relational databases. The important things to keep in mind are that map functions give you an opportunity to sort your data using any key you choose, and that CouchDB’s design is focused on providing fast, efficient access to data within a range of keys.

</div>

<h3 id="replication">Triggering Replication</h3>

<p>Futon can trigger replication between two local databases, between a local and remote database, or even between two remote databases. We’ll show you how to replicate data from one local database to another, which is a simple way of making backups of your databases as we’re working through the examples.

<p>First we’ll need to create an empty database to be the target of replication. Return to the overview and create a database called <code>hello-replication</code>. Now click “Replicator” in the sidebar and choose <code>hello-world</code> as the source and <code>hello-replication</code> as the target. Click “Replicate” to replicate your database. The result should look something like <a href="#figure/10">Figure 10, “Running database replication in Futon”</a>.

<div class="figure" id="figure/10">

<img src="tour/10.png">

<p class="caption">Figure 10. Running database replication in Futon

</div>

<div class="aside warning">

<p>For larger databases, replication can take much longer. It is important to leave the browser window open while replication is taking place. As an alternative, you can trigger replication via <code>curl</code> or some other HTTP client that can handle long-running connections. If your client closes the connection before replication finishes, you’ll have to retrigger it. Luckily, CouchDB’s replication can take over from where it left off instead of starting from scratch.

</div>

<h3 id="wrap">Wrapping Up</h3>

<p>Now that you’ve seen most of Futon’s features, you’ll be prepared to dive in and inspect your data as we build our example application in the next few chapters. Futon’s pure JavaScript approach to managing CouchDB shows how it’s possible to build a fully featured web application using only CouchDB’s HTTP API and integrated web server.

<p>But before we get there, we’ll have another look at CouchDB’s HTTP API—now with a magnifying glass. Let’s <em>curl</em> on the couch and relax.
